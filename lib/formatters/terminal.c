#include <stddef.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

#include "cpp.h"
#include "tokens.h"
#include "themes.h"
#include "formatter.h"
#include "string_builder.h"

#define BOLD      "01"
#define FAINT     "02"
#define STANDOUT  "03"
#define UNDERLINE "04"
#define BLINK     "05"
#define OVERLINE  "06"

typedef struct {
    int mode256 ALIGNED(sizeof(OptionValue));
    const Theme *theme ALIGNED(sizeof(OptionValue));
    struct {
        size_t value_len;
        const char *value;
    } sequences[_TOKEN_COUNT];
} TerminalFormatterData;

// bold (1) + italic (3) + underline (4) (unused for now) + fg (38;2;R;G;B) + bg (48;2;R;G;B)
#define LONGEST_ANSI_ESCAPE_SEQUENCE \
    "\e[1;3;4;38;2;RRR;GGG;BBB;48;2;RRR;GGG;BBBm"

static const Color mode256[] = {
    // [0x00-0x07]: standard colors (as in ESC [ 30–37 m) (based on xterm)
    { 0x00, 0x00, 0x00 }, // 0: black
    { 0xCD, 0x00, 0x00 }, // 1: red
    { 0x00, 0xCD, 0x00 }, // 2: green
    { 0xCD, 0xCD, 0x00 }, // 3: brown/yellow
    { 0x00, 0x00, 0xEE }, // 4: blue
    { 0xCD, 0x00, 0xCD }, // 5: magenta
    { 0x00, 0xCD, 0xCD }, // 6: cyan
    { 0xE5, 0xE5, 0xE5 }, // 7: gray
    // [0x08-0x0F]: high intensity colors (as in ESC [ 90–97 m) (based on xterm)
    { 0x7F, 0x7F, 0x7F }, // 0: darkgray
    { 0xFF, 0x00, 0x00 }, // 1: red
    { 0x00, 0xFF, 0x00 }, // 2: green
    { 0xFF, 0xFF, 0x00 }, // 3: yellow
    { 0x5C, 0x5C, 0xFF }, // 4: blue
    { 0xFF, 0x00, 0xFF }, // 5: magenta
    { 0x00, 0xFF, 0xFF }, // 6: cyan
    { 0xFF, 0xFF, 0xFF }, // 7: white
    // [0x10-0xE7]: 6 × 6 × 6 = 216 colors: 16 + 36 × r + 6 × g + b (0 ≤ r, g, b ≤ 5)
#if 0
<?php
$valuerange = [ 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF ];
for ($i = 0; $i < 216; $i++) {
    printf('{ 0x%02X, 0x%02X, 0x%02X },' . PHP_EOL, $valuerange[($i / count($valuerange) ** 2) % count($valuerange)], $valuerange[($i / count($valuerange)) % count($valuerange)], $valuerange[$i % count($valuerange)]);
}
#endif
    { 0x00, 0x00, 0x00 },
    { 0x00, 0x00, 0x5F },
    { 0x00, 0x00, 0x87 },
    { 0x00, 0x00, 0xAF },
    { 0x00, 0x00, 0xD7 },
    { 0x00, 0x00, 0xFF },
    { 0x00, 0x5F, 0x00 },
    { 0x00, 0x5F, 0x5F },
    { 0x00, 0x5F, 0x87 },
    { 0x00, 0x5F, 0xAF },
    { 0x00, 0x5F, 0xD7 },
    { 0x00, 0x5F, 0xFF },
    { 0x00, 0x87, 0x00 },
    { 0x00, 0x87, 0x5F },
    { 0x00, 0x87, 0x87 },
    { 0x00, 0x87, 0xAF },
    { 0x00, 0x87, 0xD7 },
    { 0x00, 0x87, 0xFF },
    { 0x00, 0xAF, 0x00 },
    { 0x00, 0xAF, 0x5F },
    { 0x00, 0xAF, 0x87 },
    { 0x00, 0xAF, 0xAF },
    { 0x00, 0xAF, 0xD7 },
    { 0x00, 0xAF, 0xFF },
    { 0x00, 0xD7, 0x00 },
    { 0x00, 0xD7, 0x5F },
    { 0x00, 0xD7, 0x87 },
    { 0x00, 0xD7, 0xAF },
    { 0x00, 0xD7, 0xD7 },
    { 0x00, 0xD7, 0xFF },
    { 0x00, 0xFF, 0x00 },
    { 0x00, 0xFF, 0x5F },
    { 0x00, 0xFF, 0x87 },
    { 0x00, 0xFF, 0xAF },
    { 0x00, 0xFF, 0xD7 },
    { 0x00, 0xFF, 0xFF },
    { 0x5F, 0x00, 0x00 },
    { 0x5F, 0x00, 0x5F },
    { 0x5F, 0x00, 0x87 },
    { 0x5F, 0x00, 0xAF },
    { 0x5F, 0x00, 0xD7 },
    { 0x5F, 0x00, 0xFF },
    { 0x5F, 0x5F, 0x00 },
    { 0x5F, 0x5F, 0x5F },
    { 0x5F, 0x5F, 0x87 },
    { 0x5F, 0x5F, 0xAF },
    { 0x5F, 0x5F, 0xD7 },
    { 0x5F, 0x5F, 0xFF },
    { 0x5F, 0x87, 0x00 },
    { 0x5F, 0x87, 0x5F },
    { 0x5F, 0x87, 0x87 },
    { 0x5F, 0x87, 0xAF },
    { 0x5F, 0x87, 0xD7 },
    { 0x5F, 0x87, 0xFF },
    { 0x5F, 0xAF, 0x00 },
    { 0x5F, 0xAF, 0x5F },
    { 0x5F, 0xAF, 0x87 },
    { 0x5F, 0xAF, 0xAF },
    { 0x5F, 0xAF, 0xD7 },
    { 0x5F, 0xAF, 0xFF },
    { 0x5F, 0xD7, 0x00 },
    { 0x5F, 0xD7, 0x5F },
    { 0x5F, 0xD7, 0x87 },
    { 0x5F, 0xD7, 0xAF },
    { 0x5F, 0xD7, 0xD7 },
    { 0x5F, 0xD7, 0xFF },
    { 0x5F, 0xFF, 0x00 },
    { 0x5F, 0xFF, 0x5F },
    { 0x5F, 0xFF, 0x87 },
    { 0x5F, 0xFF, 0xAF },
    { 0x5F, 0xFF, 0xD7 },
    { 0x5F, 0xFF, 0xFF },
    { 0x87, 0x00, 0x00 },
    { 0x87, 0x00, 0x5F },
    { 0x87, 0x00, 0x87 },
    { 0x87, 0x00, 0xAF },
    { 0x87, 0x00, 0xD7 },
    { 0x87, 0x00, 0xFF },
    { 0x87, 0x5F, 0x00 },
    { 0x87, 0x5F, 0x5F },
    { 0x87, 0x5F, 0x87 },
    { 0x87, 0x5F, 0xAF },
    { 0x87, 0x5F, 0xD7 },
    { 0x87, 0x5F, 0xFF },
    { 0x87, 0x87, 0x00 },
    { 0x87, 0x87, 0x5F },
    { 0x87, 0x87, 0x87 },
    { 0x87, 0x87, 0xAF },
    { 0x87, 0x87, 0xD7 },
    { 0x87, 0x87, 0xFF },
    { 0x87, 0xAF, 0x00 },
    { 0x87, 0xAF, 0x5F },
    { 0x87, 0xAF, 0x87 },
    { 0x87, 0xAF, 0xAF },
    { 0x87, 0xAF, 0xD7 },
    { 0x87, 0xAF, 0xFF },
    { 0x87, 0xD7, 0x00 },
    { 0x87, 0xD7, 0x5F },
    { 0x87, 0xD7, 0x87 },
    { 0x87, 0xD7, 0xAF },
    { 0x87, 0xD7, 0xD7 },
    { 0x87, 0xD7, 0xFF },
    { 0x87, 0xFF, 0x00 },
    { 0x87, 0xFF, 0x5F },
    { 0x87, 0xFF, 0x87 },
    { 0x87, 0xFF, 0xAF },
    { 0x87, 0xFF, 0xD7 },
    { 0x87, 0xFF, 0xFF },
    { 0xAF, 0x00, 0x00 },
    { 0xAF, 0x00, 0x5F },
    { 0xAF, 0x00, 0x87 },
    { 0xAF, 0x00, 0xAF },
    { 0xAF, 0x00, 0xD7 },
    { 0xAF, 0x00, 0xFF },
    { 0xAF, 0x5F, 0x00 },
    { 0xAF, 0x5F, 0x5F },
    { 0xAF, 0x5F, 0x87 },
    { 0xAF, 0x5F, 0xAF },
    { 0xAF, 0x5F, 0xD7 },
    { 0xAF, 0x5F, 0xFF },
    { 0xAF, 0x87, 0x00 },
    { 0xAF, 0x87, 0x5F },
    { 0xAF, 0x87, 0x87 },
    { 0xAF, 0x87, 0xAF },
    { 0xAF, 0x87, 0xD7 },
    { 0xAF, 0x87, 0xFF },
    { 0xAF, 0xAF, 0x00 },
    { 0xAF, 0xAF, 0x5F },
    { 0xAF, 0xAF, 0x87 },
    { 0xAF, 0xAF, 0xAF },
    { 0xAF, 0xAF, 0xD7 },
    { 0xAF, 0xAF, 0xFF },
    { 0xAF, 0xD7, 0x00 },
    { 0xAF, 0xD7, 0x5F },
    { 0xAF, 0xD7, 0x87 },
    { 0xAF, 0xD7, 0xAF },
    { 0xAF, 0xD7, 0xD7 },
    { 0xAF, 0xD7, 0xFF },
    { 0xAF, 0xFF, 0x00 },
    { 0xAF, 0xFF, 0x5F },
    { 0xAF, 0xFF, 0x87 },
    { 0xAF, 0xFF, 0xAF },
    { 0xAF, 0xFF, 0xD7 },
    { 0xAF, 0xFF, 0xFF },
    { 0xD7, 0x00, 0x00 },
    { 0xD7, 0x00, 0x5F },
    { 0xD7, 0x00, 0x87 },
    { 0xD7, 0x00, 0xAF },
    { 0xD7, 0x00, 0xD7 },
    { 0xD7, 0x00, 0xFF },
    { 0xD7, 0x5F, 0x00 },
    { 0xD7, 0x5F, 0x5F },
    { 0xD7, 0x5F, 0x87 },
    { 0xD7, 0x5F, 0xAF },
    { 0xD7, 0x5F, 0xD7 },
    { 0xD7, 0x5F, 0xFF },
    { 0xD7, 0x87, 0x00 },
    { 0xD7, 0x87, 0x5F },
    { 0xD7, 0x87, 0x87 },
    { 0xD7, 0x87, 0xAF },
    { 0xD7, 0x87, 0xD7 },
    { 0xD7, 0x87, 0xFF },
    { 0xD7, 0xAF, 0x00 },
    { 0xD7, 0xAF, 0x5F },
    { 0xD7, 0xAF, 0x87 },
    { 0xD7, 0xAF, 0xAF },
    { 0xD7, 0xAF, 0xD7 },
    { 0xD7, 0xAF, 0xFF },
    { 0xD7, 0xD7, 0x00 },
    { 0xD7, 0xD7, 0x5F },
    { 0xD7, 0xD7, 0x87 },
    { 0xD7, 0xD7, 0xAF },
    { 0xD7, 0xD7, 0xD7 },
    { 0xD7, 0xD7, 0xFF },
    { 0xD7, 0xFF, 0x00 },
    { 0xD7, 0xFF, 0x5F },
    { 0xD7, 0xFF, 0x87 },
    { 0xD7, 0xFF, 0xAF },
    { 0xD7, 0xFF, 0xD7 },
    { 0xD7, 0xFF, 0xFF },
    { 0xFF, 0x00, 0x00 },
    { 0xFF, 0x00, 0x5F },
    { 0xFF, 0x00, 0x87 },
    { 0xFF, 0x00, 0xAF },
    { 0xFF, 0x00, 0xD7 },
    { 0xFF, 0x00, 0xFF },
    { 0xFF, 0x5F, 0x00 },
    { 0xFF, 0x5F, 0x5F },
    { 0xFF, 0x5F, 0x87 },
    { 0xFF, 0x5F, 0xAF },
    { 0xFF, 0x5F, 0xD7 },
    { 0xFF, 0x5F, 0xFF },
    { 0xFF, 0x87, 0x00 },
    { 0xFF, 0x87, 0x5F },
    { 0xFF, 0x87, 0x87 },
    { 0xFF, 0x87, 0xAF },
    { 0xFF, 0x87, 0xD7 },
    { 0xFF, 0x87, 0xFF },
    { 0xFF, 0xAF, 0x00 },
    { 0xFF, 0xAF, 0x5F },
    { 0xFF, 0xAF, 0x87 },
    { 0xFF, 0xAF, 0xAF },
    { 0xFF, 0xAF, 0xD7 },
    { 0xFF, 0xAF, 0xFF },
    { 0xFF, 0xD7, 0x00 },
    { 0xFF, 0xD7, 0x5F },
    { 0xFF, 0xD7, 0x87 },
    { 0xFF, 0xD7, 0xAF },
    { 0xFF, 0xD7, 0xD7 },
    { 0xFF, 0xD7, 0xFF },
    { 0xFF, 0xFF, 0x00 },
    { 0xFF, 0xFF, 0x5F },
    { 0xFF, 0xFF, 0x87 },
    { 0xFF, 0xFF, 0xAF },
    { 0xFF, 0xFF, 0xD7 },
    { 0xFF, 0xFF, 0xFF },
    // [0xE8-0xFF]: grayscale from black to white in 24 steps
#if 0
for ($i = 0; $i < 24; $i++) {
    printf('{ 0x%1$02X, 0x%1$02X, 0x%1$02X },' . PHP_EOL, 8 + 10 * $i);
}
#endif
    { 0x08, 0x08, 0x08 },
    { 0x12, 0x12, 0x12 },
    { 0x1C, 0x1C, 0x1C },
    { 0x26, 0x26, 0x26 },
    { 0x30, 0x30, 0x30 },
    { 0x3A, 0x3A, 0x3A },
    { 0x44, 0x44, 0x44 },
    { 0x4E, 0x4E, 0x4E },
    { 0x58, 0x58, 0x58 },
    { 0x62, 0x62, 0x62 },
    { 0x6C, 0x6C, 0x6C },
    { 0x76, 0x76, 0x76 },
    { 0x80, 0x80, 0x80 },
    { 0x8A, 0x8A, 0x8A },
    { 0x94, 0x94, 0x94 },
    { 0x9E, 0x9E, 0x9E },
    { 0xA8, 0xA8, 0xA8 },
    { 0xB2, 0xB2, 0xB2 },
    { 0xBC, 0xBC, 0xBC },
    { 0xC6, 0xC6, 0xC6 },
    { 0xD0, 0xD0, 0xD0 },
    { 0xDA, 0xDA, 0xDA },
    { 0xE4, 0xE4, 0xE4 },
    { 0xEE, 0xEE, 0xEE },
};

static uint8_t closest_color_for_256_mode(const Color *original)
{
    size_t i;
    uint8_t match;
    int min_distance;

    match = 0;
    min_distance = 257 * 257 * 3;
    for (i = 0; i < ARRAY_SIZE(mode256); i++) {
        int rd, gd, bd, current_distance;

        rd = original->r - mode256[i].r;
        gd = original->g - mode256[i].g;
        bd = original->b - mode256[i].b;
        current_distance = rd * rd + gd * gd + bd * bd;
        if (current_distance < min_distance) {
            match = i;
            min_distance = current_distance;
        }
    }

    return match;
}

STRING_BUILDER_DECL(STR_SIZE(LONGEST_ANSI_ESCAPE_SEQUENCE));

static int terminal_start_document(String *UNUSED(out), FormatterData *data)
{
    size_t i;
    const Theme *theme;
    TerminalFormatterData *mydata;

    mydata = (TerminalFormatterData *) data;
    // TODO: define a default theme in shall itself
    if (NULL == (theme = mydata->theme)) {
        theme = theme_by_name("molokai");
    }
    for (i = 0; i < _TOKEN_COUNT; i++) {
        mydata->sequences[i].value_len = 0;
        mydata->sequences[i].value = NULL;
        if (theme->styles[i].flags) {
            string_builder_t sb;

            STRING_BUILDER_INIT(sb);
            STRING_BUILDER_APPEND(sb, "\e[");
            if (theme->styles[i].bold) {
                STRING_BUILDER_APPEND(sb, "1;");
            }
            if (theme->styles[i].italic) {
                STRING_BUILDER_APPEND(sb, "3;");
            }
            if (theme->styles[i].fg_set) {
                if (mydata->mode256) {
                    STRING_BUILDER_APPEND_FORMATTED(sb, "38;5;%" PRIu8 ";", closest_color_for_256_mode(&theme->styles[i].fg));
                } else {
                    STRING_BUILDER_APPEND_FORMATTED(sb, "38;2;%" PRIu8 ";%" PRIu8 ";%" PRIu8 ";", theme->styles[i].fg.r, theme->styles[i].fg.g, theme->styles[i].fg.b);
                }
            }
            if (theme->styles[i].bg_set) {
                if (mydata->mode256) {
                    STRING_BUILDER_APPEND_FORMATTED(sb, "48;5;%" PRIu8 ";", closest_color_for_256_mode(&theme->styles[i].bg));
                } else {
                    STRING_BUILDER_APPEND_FORMATTED(sb, "48;2;%" PRIu8 ";%" PRIu8 ";%" PRIu8 ";", theme->styles[i].bg.r, theme->styles[i].bg.g, theme->styles[i].bg.b);
                }
            }
            sb.w[-1] = 'm'; // overwrite last ';'
            STRING_BUILDER_DUP_INTO(sb, mydata->sequences[i].value);
        }
    }

    return 0;
}

static int terminal_end_document(String *UNUSED(out), FormatterData *data)
{
    size_t i;
    TerminalFormatterData *mydata;

    mydata = (TerminalFormatterData *) data;
    for (i = 0; i < _TOKEN_COUNT; i++) {
        if (mydata->sequences[i].value_len > 0) {
            free((void *) mydata->sequences[i].value);
        }
    }

    return 0;
}

static int terminal_start_token(int token, String *out, FormatterData *data)
{
    TerminalFormatterData *mydata;

    mydata = (TerminalFormatterData *) data;
    if (mydata->sequences[token].value_len > 0) {
        string_append_string_len(out, mydata->sequences[token].value, mydata->sequences[token].value_len);
    }

    return 0;
}

static int terminal_end_token(int token, String *out, FormatterData *data)
{
    TerminalFormatterData *mydata;

    mydata = (TerminalFormatterData *) data;
    if (mydata->sequences[token].value_len > 0) {
        STRING_APPEND_STRING(out, "\e[39;49;00m");
    }

    return 0;
}

static int terminal_write_token(String *out, const char *token, size_t token_len, FormatterData *UNUSED(data))
{
    string_append_string_len(out, token, token_len);

    return 0;
}

const FormatterImplementation _termfmt = {
    "Terminal",
    "Format tokens with ANSI color sequences, for output in a text console",
#ifndef WITHOUT_FORMATTER_OPTIONS
    formatter_implementation_default_get_option_ptr,
#endif
    terminal_start_document,
    terminal_end_document,
    terminal_start_token,
    terminal_end_token,
    terminal_write_token,
    NULL,
    NULL,
    sizeof(TerminalFormatterData),
    (/*const*/ FormatterOption /*const*/ []) {
        { S("theme"),   OPT_TYPE_THEME, offsetof(TerminalFormatterData, theme),   OPT_DEF_THEME,   "the theme to use" },
        { S("mode256"), OPT_TYPE_BOOL,  offsetof(TerminalFormatterData, mode256), OPT_DEF_BOOL(0), "if true, restrict color scheme to 256 colors" },
        END_OF_FORMATTER_OPTIONS
    }
};

/*SHALL_API*/ const FormatterImplementation *termfmt = &_termfmt;
